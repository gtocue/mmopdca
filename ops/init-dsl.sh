#!/usr/bin/env sh
set -eu

###############################################################################
# init-dsl.sh
# 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
# 繝ｻDSL 繝・ぅ繝ｬ繧ｯ繝医Μ・医Δ繝・Ν・愁SL 繝輔ぃ繧､繝ｫ・峨→繝√ぉ繝・け繝昴う繝ｳ繝育畑繝・ぅ繝ｬ繧ｯ繝医Μ繧・#   蠢・★逕ｨ諢上＠縺ｦ縺九ｉ繧｢繝励Μ譛ｬ菴薙ｒ襍ｷ蜍輔☆繧九お繝ｳ繝医Μ繝昴う繝ｳ繝医・# 繝ｻ髢狗匱迺ｰ蠅・〒縺ｯ UID=1000 / GID=1000 縺梧嶌縺崎ｾｼ繧√ｋ繧医≧ chown 縺吶ｋ縲・###############################################################################

# 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 0. DIRS 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
DSL_ROOT="${DSL_ROOT:-/mnt/data/dsl}"
CKPT_ROOT="${CKPT_ROOT:-/mnt/checkpoints}"

echo "[init-dsl] Ensuring DSL dir  : ${DSL_ROOT}"
echo "[init-dsl] Ensuring CKPT dir : ${CKPT_ROOT}"
mkdir -p "${DSL_ROOT}" "${CKPT_ROOT}"

# 髢狗匱迺ｰ蠅・ｼ・ocker Desktop / docker compose・峨〒縺ｯ縲UID 1000 縺悟虚縺九☆縺溘ａ謇譛画ｨｩ繧定ｭｲ繧・# 螟ｱ謨励＠縺ｦ繧ゑｼ域悽逡ｪ root 螳溯｡後↑縺ｩ・臥┌隕悶＠縺ｦ邯夊｡・chown -R 1000:1000 "${DSL_ROOT}" "${CKPT_ROOT}" 2>/dev/null || true
echo "[init-dsl] Dirs ready."

# 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 1. EXEC 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
echo "[init-dsl] Exec $*"
case "$1" in
  # ---------- FastAPI ----------
  uvicorn)
    shift
    exec python -m uvicorn "$@"
    ;;

  # ---------- Celery (worker / beat) ----------
  celery)
    shift
    exec celery "$@"
    ;;

  # ---------- 縺昴・莉悶◎縺ｮ縺ｾ縺ｾ ----------
  *)
    exec "$@"
    ;;
esac

