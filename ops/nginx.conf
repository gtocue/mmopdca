# ────────────────────────────────────────────────
# NGINX 逆プロキシ (自己署名 TLS / HTTP→HTTPS 強制)
#  - API      : https://<host>/api/…
#  - Grafana  : https://<host>/grafana/…
# ────────────────────────────────────────────────
events { }

http {
    ## 証明書・鍵
    ssl_certificate     /etc/nginx/cert.pem;
    ssl_certificate_key /etc/nginx/key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    ## HTTP を HTTPS へリダイレクト
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    ## HTTPS フロント
    server {
        listen 443 ssl;
        server_name _;

        # ───── API (FastAPI)
        location / {
            proxy_pass         http://api:8001;
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-Proto https;
            proxy_set_header   X-Real-IP $remote_addr;
        }

        # ───── Grafana
        location /grafana/ {
            proxy_pass         http://grafana:3000/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-Proto https;
            proxy_set_header   X-Real-IP $remote_addr;
            # 末尾スラッシュ必須 (Grafana 固有)
            proxy_redirect     off;
        }
    }
}
