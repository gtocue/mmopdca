# GitHub Actions - Docker Stack Health
name: stack-health        # ← ASCII のみ

on:
  push:
    branches: [ main, develop ]
  pull_request: {}

jobs:
  compose-health:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4      # 基本ステップ :contentReference[oaicite:0]{index=0}
      - uses: docker/setup-buildx-action@v3  # buildx 初期化 :contentReference[oaicite:1]{index=1}

      # ---------- .env を生成 ----------
      - name: Create .env
        run: |
          cat > .env <<'EOF'
          POSTGRES_DB=mmopdca
          POSTGRES_USER=mmop_user
          POSTGRES_PASSWORD=password
          REDIS_PASSWORD=
          DSL_ROOT=/mnt/data/dsl
          TZ=UTC
          EOF
          head -n 10 .env

      # ---------- Stack 起動 ----------
      - name: Docker Compose up
        run: |
          docker compose --env-file .env -f docker/compose.ci.yml up -d --build
          docker compose --env-file .env -f docker/compose.ci.yml ps

      # ---------- ヘルス待ち ----------
      - name: Wait for endpoints
        run: |
          set -eu
          for i in {1..30}; do
            curl -fs http://localhost:8001/docs      && \
            curl -fs http://localhost:9090/          && \
            curl -fs http://localhost:9121/metrics   && \
            curl -fs http://localhost:9808/metrics   && exit 0
            sleep 4
          done
          echo "Timeout"; docker compose logs --tail=50; exit 1

      - name: Docker Compose down
        if: always()
        run: docker compose -f docker/compose.ci.yml down -v --remove-orphans
