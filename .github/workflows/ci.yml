# .github/workflows/ci.yml
#
# GitHub Actions â€• ã‚³ãƒ³ãƒ†ãƒŠç¾¤ãŒ â€œèµ·å‹•ã—ã¦ 200 OK ã‚’è¿”ã™â€ ã¾ã§ã‚’
# è‡ªå‹•ãƒ†ã‚¹ãƒˆã™ã‚‹æœ€å° CIã€‚push / PR ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
#
# â¶ .env ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰
# â· docker-compose (core + db + ports) ã‚’ â€•build ä»˜ãã§èµ·å‹•
# â¸ 4 ã¤ã®ãƒ˜ãƒ«ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« 200 ãŒè¿”ã‚‹ã¾ã§ãƒªãƒˆãƒ©ã‚¤
# â¹ æˆåŠŸã™ã‚Œã°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ green
#
# â€» â€œassistant keyâ€ ã«æ²¿ã„ã€ã‚³ãƒ¡ãƒ³ãƒˆã¯ã™ã¹ã¦æ—¥æœ¬èªï¼80 æ¡ä»¥å†…
# ---------------------------------------------------------------------

name: CI (Docker Compose)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  compose-ci:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1) ã‚½ãƒ¼ã‚¹ã‚’å–å¾—
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2) æœ€å°æ§‹æˆã® .env ã‚’å‹•çš„ç”Ÿæˆ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ› ï¸ Generate minimal .env (for CI)
      run: |
        cat <<'EOF' > .env
        # ---------- Redis ----------
        REDIS_PASSWORD=testpass123
        REDIS_PASSWORD_ENC=$(python - <<'PY'
        import urllib.parse, os, sys
        print(urllib.parse.quote(os.getenv("REDIS_PASSWORD", "testpass123")))
        PY
        )
        # ---------- PostgreSQL ----------
        POSTGRES_DB=mmopdca
        POSTGRES_USER=mmop_user
        POSTGRES_PASSWORD=mmop_pw
        # ---------- Paths ----------
        DSL_ROOT=/mnt/data/dsl
        # ---------- Misc ----------
        LOG_LEVEL=INFO
        TZ=UTC
        EOF

        echo 'ğŸ”‘  .env generated:'
        cat .env

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3) Buildx (ãƒ¬ã‚¤ãƒ¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ³ Set-up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4) Compose up (ãƒ“ãƒ«ãƒ‰ï¼‹ãƒ‡ã‚¿ãƒƒãƒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸš€ Compose up (build & detached)
      run: |
        docker compose \
          --env-file .env \
          -f docker/compose.core.yml \
          -f docker/compose.db.yml \
          -f docker/compose.ports.yml \
          up -d --build

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5) ä¸»è¦ãƒãƒ¼ãƒˆãŒ 200 ã‚’è¿”ã™ã¾ã§å¾…æ©Ÿ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â³ Wait until all ports return HTTP 200
      run: |
        set -e
        ports=(8001 3000 9090 9121 9808)
        paths=("/docs" "/" "/metrics" "/metrics" "/metrics")
        max_retry=30

        for i in "${!ports[@]}"; do
          p=${ports[$i]}
          path=${paths[$i]}
          try=0
          until curl -fsS "http://localhost:${p}${path}" -o /dev/null; do
            if [ $try -ge $max_retry ]; then
              echo "âŒ  Port ${p}${path} failed to return 200 in time" >&2
              docker compose down -v --remove-orphans
              exit 1
            fi
            echo "â³  Waiting for http://localhost:${p}${path} (try $try)"
            try=$((try+1))
            sleep 3
          done
          echo "âœ…  http://localhost:${p}${path} is up"
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6) (ä»»æ„) ã“ã“ã§ pytest ãªã©å®Ÿè¡Œ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # - name: ğŸ§ª Run tests
    #   run: pytest -q tests/

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7) å¾Œç‰‡ä»˜ã‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§¹ Compose down (always)
      if: always()
      run: |
        docker compose \
          --env-file .env \
          -f docker/compose.core.yml \
          -f docker/compose.db.yml \
          -f docker/compose.ports.yml \
          down -v --remove-orphans
