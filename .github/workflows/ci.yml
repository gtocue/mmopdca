# .github/workflows/ci.yml
name: CI - compose up & healthcheck

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  compose-up-test:
    runs-on: ubuntu-latest

    # â¶ Docker/Compose ã‚’ä½¿ã†ãŸã‚ç‰¹æ¨©ãƒ¢ãƒ¼ãƒ‰
    permissions:
      contents: read
    steps:
      #-------------------------------------------------------------------#
      # 0. äº‹å‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      #-------------------------------------------------------------------#
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compose version
        run: docker compose version

      #-------------------------------------------------------------------#
      # 1. .env ã‚’ç”Ÿæˆ ï¼ˆREDIS_PASSWORD ã¯ãƒ€ãƒŸãƒ¼ã§ OKï¼‰
      #-------------------------------------------------------------------#
      - name: Create .env for CI
        run: |
          cat > .env <<'EOF'
          REDIS_PASSWORD=ci_test_pass
          REDIS_PASSWORD_ENC=ci_test_pass
          POSTGRES_DB=mmopdca
          POSTGRES_USER=mmop_user
          POSTGRES_PASSWORD=PgPass
          DSL_ROOT=/mnt/data/dsl
          LOG_LEVEL=INFO
          TZ=UTC
          EOF

      #-------------------------------------------------------------------#
      # 2. Compose up ï¼ˆcore + db + portsï¼‰
      #-------------------------------------------------------------------#
      - name: Compose up -d
        run: |
          docker compose \
            -f docker/compose.core.yml \
            -f docker/compose.db.yml   \
            -f docker/compose.ports.yml \
            up -d --build

      #-------------------------------------------------------------------#
      # 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ8001 / 9090 / 9121 / 9808ï¼‰
      #    30 ç§’ä»¥å†…ã« 200 ãŒè¿”ã‚‰ãªã‘ã‚Œã°å¤±æ•—
      #-------------------------------------------------------------------#
      - name: Wait for services
        run: |
          endpoints=("8001/docs" "9090" "9121/metrics" "9808/metrics")
          for ep in "${endpoints[@]}"; do
            echo "ðŸ”Ž Health-check http://localhost:${ep}"
            for i in {1..30}; do
              status=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:${ep} || true)
              if [ "$status" = "200" ]; then
                echo "âœ… $ep â†’ 200 OK"
                break
              fi
              sleep 2
              if [ "$i" = "30" ]; then
                echo "âŒ $ep did not return 200 within timeout"
                docker compose logs --tail=50
                exit 1
              fi
            done
          done

      #-------------------------------------------------------------------#
      # 4. å¾Œç‰‡ä»˜ã‘
      #-------------------------------------------------------------------#
      - name: Compose down
        if: always()
        run: |
          docker compose \
            -f docker/compose.core.yml \
            -f docker/compose.db.yml   \
            -f docker/compose.ports.yml \
            down -v --remove-orphans
